{% extends "base.html" %}

{% block title %}Synonym Game{% endblock %}

{% block header %}Synonym Matching Game{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div id="game-container">
                <!-- Game info -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span id="timer" class="badge bg-secondary fs-5">5:00</span>
                                <span class="ms-2">Time Remaining</span>
                            </div>
                            <div>
                                <span id="score" class="badge bg-primary fs-5">0</span>
                                <span class="ms-2">Score</span>
                            </div>
                            <div>
                                <span id="round" class="badge bg-info fs-5">1</span>
                                <span class="ms-2">Round</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Progress bar -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="progress">
                            <div id="game-progress" class="progress-bar" role="progressbar" style="width: 20%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Game area -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <!-- Three-box game area -->
                                <div class="row mb-4">
                                    <!-- Left meaning box -->
                                    <div class="col-md-3 mb-3 mb-md-0">
                                        <div class="border rounded p-3 h-100 d-flex flex-column meaning-box" id="meaning-box-1">
                                            <h5 class="text-center mb-3" id="meaning-1">Meaning 1</h5>
                                            <div class="d-flex flex-wrap word-container" id="meaning-1-words">
                                                <!-- Words assigned to meaning 1 will appear here -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Middle word display -->
                                    <div class="col-md-6 mb-3 mb-md-0">
                                        <div class="border rounded p-3 h-100 d-flex flex-column align-items-center" id="word-display-box">
                                            <h5 class="text-center mb-3">Current Word</h5>
                                            <div class="word-display mb-3">
                                                <span id="current-word" class="badge bg-success fs-4">Word</span>
                                            </div>
                                            <div class="d-flex justify-content-between w-100">
                                                <button id="left-arrow" class="btn btn-info arrow-btn">
                                                    <i class="fas fa-arrow-left"></i> Meaning 1
                                                </button>
                                                <button id="right-arrow" class="btn btn-info arrow-btn">
                                                    Meaning 2 <i class="fas fa-arrow-right"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Right meaning box -->
                                    <div class="col-md-3">
                                        <div class="border rounded p-3 h-100 d-flex flex-column meaning-box" id="meaning-box-2">
                                            <h5 class="text-center mb-3" id="meaning-2">Meaning 2</h5>
                                            <div class="d-flex flex-wrap word-container" id="meaning-2-words">
                                                <!-- Words assigned to meaning 2 will appear here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Word progress -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-center align-items-center">
                                            <span id="words-remaining" class="badge bg-secondary">Words remaining: 0</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Feedback area -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div id="round-feedback" class="text-center"></div>
                                    </div>
                                </div>
                                
                                <!-- Controls -->
                                <div class="row mt-4">
                                    <div class="col-12 text-center">
                                        <button id="start-game-btn" class="btn btn-success btn-lg btn-game-control">Start Game</button>
                                        <button id="next-round-btn" class="btn btn-primary btn-lg btn-game-control d-none" disabled>Next Round</button>
                                        <button id="end-game-btn" class="btn btn-danger btn-lg btn-game-control d-none">End Game</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Game summary -->
                <div class="row mt-4 d-none" id="game-summary">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body text-center">
                                <h3>Game Complete!</h3>
                                <h4>Your Score: <span id="final-score">0</span> / 1000</h4>
                                <button id="play-again-btn" class="btn btn-primary btn-lg mt-3 btn-game-control">Play Again</button>
                                <a href="{{ url_for('flash_card.dashboard') }}" class="btn btn-secondary btn-lg mt-3 btn-game-control">Back to Dashboard</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Synonym Game JavaScript -->
<script>
    // Game state variables
    let gameId = null;
    let currentRound = 1;
    let totalScore = 0;
    let timerInterval = null;
    let timeRemaining = 5 * 60; // 5 minutes in seconds
    let currentWords = []; // Words for the current round
    let currentWordIndex = 0; // Index of the current word being displayed
    let userAnswers = {}; // {word: meaning}
    let correctAnswers = {}; // {word: correct meaning}
    let roundScores = {}; // {word: score}
    
    // DOM Elements
    const timerElement = document.getElementById('timer');
    const scoreElement = document.getElementById('score');
    const roundElement = document.getElementById('round');
    const meaning1Element = document.getElementById('meaning-1');
    const meaning2Element = document.getElementById('meaning-2');
    const meaning1WordsElement = document.getElementById('meaning-1-words');
    const meaning2WordsElement = document.getElementById('meaning-2-words');
    const currentWordElement = document.getElementById('current-word');
    const leftArrowBtn = document.getElementById('left-arrow');
    const rightArrowBtn = document.getElementById('right-arrow');
    const roundFeedbackElement = document.getElementById('round-feedback');
    const gameProgressElement = document.getElementById('game-progress');
    const startGameBtn = document.getElementById('start-game-btn');
    const nextRoundBtn = document.getElementById('next-round-btn');
    const endGameBtn = document.getElementById('end-game-btn');
    const gameSummaryElement = document.getElementById('game-summary');
    const finalScoreElement = document.getElementById('final-score');
    const playAgainBtn = document.getElementById('play-again-btn');
    const wordsRemainingElement = document.getElementById('words-remaining');
    
    // Format time as MM:SS
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    // Update timer display
    function updateTimer() {
        timerElement.textContent = formatTime(timeRemaining);
        
        // Change color when time is running low
        if (timeRemaining <= 1 * 60) {
            timerElement.classList.remove('bg-secondary');
            timerElement.classList.add('bg-danger');
        }
        
        // End game when time runs out
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            endGame();
        }
        
        timeRemaining--;
    }
    
    // Start the game timer
    function startTimer() {
        timeRemaining = 5 * 60; // Reset to 5 minutes
        timerElement.textContent = formatTime(timeRemaining);
        timerInterval = setInterval(updateTimer, 1000);
    }
    
    // Stop the game timer
    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }
    
    // Start a new game
    function startGame() {
        fetch('/flash_card/api/synonym-game/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'Game started') {
                gameId = data.game_id;
                currentRound = 1;
                totalScore = 0;
                scoreElement.textContent = totalScore;
                roundElement.textContent = currentRound;
                
                startGameBtn.classList.add('d-none');
                nextRoundBtn.classList.remove('d-none');
                endGameBtn.classList.remove('d-none');
                
                startTimer();
                loadNextRound();
            } else {
                alert('Failed to start game: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error starting game:', error);
            alert('Failed to start game. Please try again.');
        });
    }
    
    // Load the next round
    function loadNextRound() {
        // Clear previous feedback
        roundFeedbackElement.innerHTML = '';
        
        // Update round display
        roundElement.textContent = currentRound;
        gameProgressElement.style.width = `${(currentRound / 5) * 100}%`;
        
        // Clear previous words and containers
        meaning1WordsElement.innerHTML = '';
        meaning2WordsElement.innerHTML = '';
        currentWordElement.textContent = '';
        
        // Reset user answers and game state
        userAnswers = {};
        correctAnswers = {};
        roundScores = {};
        currentWords = [];
        currentWordIndex = 0;
        
        fetch('/flash_card/api/synonym-game/next-round')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error loading round: ' + data.error);
                return;
            }
            
            // Display meanings
            meaning1Element.textContent = data.meanings[0];
            meaning2Element.textContent = data.meanings[1];
            leftArrowBtn.innerHTML = `⫷ ${data.meanings[0]}`;
            rightArrowBtn.innerHTML = `${data.meanings[1]} ⫸`;
            
            // Store correct answers
            data.categories.forEach(category => {
                category.words.forEach(word => {
                    correctAnswers[word] = category.meaning;
                });
            });
            
            // Store words for this round
            currentWords = [...data.words];
            
            // Update words remaining display
            updateWordsRemaining();
            
            // Display the first word
            if (currentWords.length > 0) {
                displayCurrentWord();
            }
            
            // Disable next round button until all words are processed
            nextRoundBtn.disabled = true;
        })
        .catch(error => {
            console.error('Error loading round:', error);
            alert('Error loading round. Please try again.');
        });
    }
    
    // Update words remaining display
    function updateWordsRemaining() {
        const remaining = currentWords.length - currentWordIndex;
        wordsRemainingElement.textContent = `Words remaining: ${remaining}`;
    }
    
    // Display the current word
    function displayCurrentWord() {
        if (currentWordIndex < currentWords.length) {
            currentWordElement.textContent = currentWords[currentWordIndex];
        } else {
            currentWordElement.textContent = 'Round Complete!';
            // All words processed, enable next round button
            nextRoundBtn.disabled = false;
        }
        updateWordsRemaining();
    }
    
    // Process word assignment
    function processWordAssignment(meaningElement, meaningText) {
        if (currentWordIndex >= currentWords.length) return;
        
        const word = currentWords[currentWordIndex];
        userAnswers[word] = meaningText;
        
        // Create word pill
        const wordPill = document.createElement('span');
        wordPill.className = 'badge m-1 p-2 word-pill';
        wordPill.textContent = word;
        wordPill.setAttribute('data-word', word);
        
        // Check if answer is correct and set color
        const isCorrect = correctAnswers[word] === meaningText;
        if (isCorrect) {
            wordPill.classList.add('bg-success'); // Green for correct
            roundScores[word] = 10; // 10 points for correct answer
        } else {
            wordPill.classList.add('bg-danger'); // Red for incorrect
            roundScores[word] = 0; // 0 points for incorrect answer
        }
        
        // Add to the appropriate meaning box
        meaningElement.appendChild(wordPill);
        
        // Update total score
        totalScore += roundScores[word];
        scoreElement.textContent = totalScore;
        
        // Move to next word
        currentWordIndex++;
        displayCurrentWord();
        
        // If all words are processed, enable next round button
        if (currentWordIndex >= currentWords.length) {
            nextRoundBtn.disabled = false;
        }
    }
    
    // Submit round answers
    function submitRound() {
        fetch('/flash_card/api/synonym-game/submit-round', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                answers: userAnswers
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error submitting round: ' + data.error);
                return;
            }
            
            // Update total score
            totalScore = data.total_score;
            scoreElement.textContent = totalScore;
            
            // Show feedback
            let feedbackHtml = '<div class="alert alert-info">';
            feedbackHtml += '<h5>Round Results:</h5>';
            data.scores.forEach(score => {
                feedbackHtml += `<p>${score.meaning}: ${score.correct}/${score.total} correct (${score.percentage.toFixed(1)}%)</p>`;
            });
            feedbackHtml += `<p><strong>Round Score: ${data.total_score}/${data.max_possible_score}</strong></p>`;
            feedbackHtml += '</div>';
            
            roundFeedbackElement.innerHTML = feedbackHtml;
            
            // Hide submit button and show next round or end game button
            if (currentRound >= 5) {
                endGame();
            } else {
                nextRoundBtn.classList.remove('d-none');
                currentRound++;
            }
        })
        .catch(error => {
            console.error('Error submitting round:', error);
            alert('Error submitting round. Please try again.');
        });
    }
    
    // Load next round
    function nextRound() {
        submitRound();
    }
    
    // End the game
    function endGame() {
        stopTimer();
        
        fetch('/flash_card/api/synonym-game/end', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'Game ended') {
                // Show game summary
                finalScoreElement.textContent = data.total_score;
                
                // Hide game container and show summary
                document.getElementById('game-container').classList.add('d-none');
                gameSummaryElement.classList.remove('d-none');
            } else {
                alert('Failed to end game: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error ending game:', error);
            alert('Failed to end game. Please try again.');
        });
    }
    
    // Play again
    function playAgain() {
        // Hide summary and show game container
        gameSummaryElement.classList.add('d-none');
        document.getElementById('game-container').classList.remove('d-none');
        
        // Reset game state
        gameId = null;
        currentRound = 1;
        totalScore = 0;
        timeRemaining = 5 * 60;
        currentWords = [];
        currentWordIndex = 0;
        userAnswers = {};
        correctAnswers = {};
        roundScores = {};
        
        // Reset UI
        scoreElement.textContent = totalScore;
        roundElement.textContent = currentRound;
        timerElement.textContent = formatTime(timeRemaining);
        timerElement.classList.remove('bg-danger');
        timerElement.classList.add('bg-secondary');
        gameProgressElement.style.width = '20%';
        
        // Reset buttons
        startGameBtn.classList.remove('d-none');
        nextRoundBtn.classList.add('d-none');
        endGameBtn.classList.add('d-none');
        
        // Clear game area
        meaning1Element.textContent = 'Meaning 1';
        meaning2Element.textContent = 'Meaning 2';
        meaning1WordsElement.innerHTML = '';
        meaning2WordsElement.innerHTML = '';
        currentWordElement.textContent = '';
        roundFeedbackElement.innerHTML = '';
        wordsRemainingElement.textContent = 'Words remaining: 0';
    }
    
    // Event listeners
    startGameBtn.addEventListener('click', startGame);
    nextRoundBtn.addEventListener('click', nextRound);
    endGameBtn.addEventListener('click', endGame);
    playAgainBtn.addEventListener('click', playAgain);
    
    // Arrow button event listeners
    leftArrowBtn.addEventListener('click', function() {
        processWordAssignment(meaning1WordsElement, meaning1Element.textContent);
    });
    
    rightArrowBtn.addEventListener('click', function() {
        processWordAssignment(meaning2WordsElement, meaning2Element.textContent);
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Game might already be active, check with backend
        // For simplicity, we'll assume no active game at page load
    });
</script>
{% endblock %}